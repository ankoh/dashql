#include "dashql/view/plan_view_model.h"

#include "gtest/gtest.h"

using namespace dashql;

namespace {

TEST(PlanViewModelTest, HyperTPCHQ18) {
    std::string_view plan =
        R"HYPERPLAN({"operator":"executiontarget","operatorId":1,"cardinality":100,"producesRows":true,"output":[{"expression":"iuref","iu":["v",["Varchar",25]]},{"expression":"iuref","iu":["v2",["Integer"]]},{"expression":"iuref","iu":["v3",["Integer"]]},{"expression":"iuref","iu":["v4",["Date"]]},{"expression":"iuref","iu":["v5",["Numeric",12,2]]},{"expression":"iuref","iu":["v6",["BigNumeric",38,2]]}],"outputNames":["c_name","c_custkey","o_orderkey","o_orderdate","o_totalprice","sum"],"input":{"operator":"sort","operatorId":2,"sqlpos":[[777,794],[816,826]],"cardinality":100,"criterion":[{"value":{"expression":"iuref","iu":"v5"},"descending":true,"nullFirst":true},{"value":{"expression":"iuref","iu":"v4"},"descending":false,"nullFirst":false}],"limit":100,"input":{"operator":"groupby","operatorId":3,"sqlpos":[[654,759],[239,254]],"cardinality":203.17,"input":{"operator":"join","operatorId":4,"cardinality":225.745,"method":"hash","referencedByScanEarlyProbe":true,"left":{"operator":"join","operatorId":5,"cardinality":50.5164,"method":"hash","referencedByScanEarlyProbe":true,"left":{"operator":"rightsemijoin","operatorId":6,"cardinality":50.5164,"method":"hash","singleMatch":true,"referencedByScanEarlyProbe":true,"left":{"operator":"select","operatorId":7,"cardinality":64,"input":{"operator":"groupby","operatorId":8,"sqlpos":[[469,512],[552,567]],"cardinality":128,"input":{"operator":"tablescan","operatorId":9,"sqlpos":[[444,452]],"cardinality":572,"relationId":7,"schema":{"type":"sessionschema"},"values":[{"name":"l_orderkey","type":["Integer"],"iu":["v7",["Integer"]]},{"name":"l_partkey","type":["Integer"],"iu":null},{"name":"l_suppkey","type":["Integer"],"iu":null},{"name":"l_linenumber","type":["Integer"],"iu":null},{"name":"l_quantity","type":["Numeric",12,2],"iu":["v8",["Numeric",12,2]]},{"name":"l_extendedprice","type":["Numeric",12,2],"iu":null},{"name":"l_discount","type":["Numeric",12,2],"iu":null},{"name":"l_tax","type":["Numeric",12,2],"iu":null},{"name":"l_returnflag","type":["Char1"],"iu":null},{"name":"l_linestatus","type":["Char1"],"iu":null},{"name":"l_shipdate","type":["Date"],"iu":null},{"name":"l_commitdate","type":["Date"],"iu":null},{"name":"l_receiptdate","type":["Date"],"iu":null},{"name":"l_shipinstruct","type":["Char",25],"iu":null},{"name":"l_shipmode","type":["Char",10],"iu":null},{"name":"l_comment","type":["Varchar",44],"iu":null}],"debugName":{"classification":"nonsensitive","value":"lineitem"},"selectivity":1},"keyExpressions":[{"expression":{"value":{"expression":"iuref","iu":"v7"}},"iu":["v9",["Integer"]]}],"groupingSets":[{"keyIndices":[0],"coreIndices":[0],"behavior":"regular"}],"emptyGroups":false,"aggExpressions":[{"value":{"expression":"iuref","iu":"v8"}}],"aggregates":[{"source":0,"operation":{"aggregate":"sum"},"iu":["v10",["BigNumeric",38,2]]}]},"condition":{"expression":"comparison","mode":"&gt;","left":{"expression":"iuref","iu":"v10"},"right":{"expression":"const","value":{"type":["BigNumeric",38,2],"low":30000,"high":0}}}},"right":{"operator":"tablescan","operatorId":10,"sqlpos":[[286,292]],"cardinality":128,"relationId":6,"schema":{"type":"sessionschema"},"values":[{"name":"o_orderkey","type":["Integer"],"iu":["v11",["Integer"]]},{"name":"o_custkey","type":["Integer"],"iu":["v12",["Integer"]]},{"name":"o_orderstatus","type":["Char1"],"iu":null},{"name":"o_totalprice","type":["Numeric",12,2],"iu":["v13",["Numeric",12,2]]},{"name":"o_orderdate","type":["Date"],"iu":["v14",["Date"]]},{"name":"o_orderpriority","type":["Char",15],"iu":null},{"name":"o_clerk","type":["Char",15],"iu":null},{"name":"o_shippriority","type":["Integer"],"iu":null},{"name":"o_comment","type":["Varchar",79],"iu":null}],"debugName":{"classification":"nonsensitive","value":"orders"},"earlyProbes":[{"builder":6,"attributes":[0],"type":"lookup","passOnNulls":false}],"selectivity":1},"condition":{"expression":"comparison","mode":"=","left":{"expression":"iuref","iu":"v11"},"right":{"expression":"iuref","iu":"v9"}}},"right":{"operator":"tablescan","operatorId":11,"sqlpos":[[268,276]],"cardinality":129,"relationId":5,"schema":{"type":"sessionschema"},"values":[{"name":"c_custkey","type":["Integer"],"iu":["v15",["Integer"]]},{"name":"c_name","type":["Varchar",25],"iu":["v16",["Varchar",25]]},{"name":"c_address","type":["Varchar",40],"iu":null},{"name":"c_nationkey","type":["Integer"],"iu":null},{"name":"c_phone","type":["Char",15],"iu":null},{"name":"c_acctbal","type":["Numeric",12,2],"iu":null},{"name":"c_mktsegment","type":["Char",10],"iu":null},{"name":"c_comment","type":["Varchar",117],"iu":null}],"debugName":{"classification":"nonsensitive","value":"customer"},"earlyProbes":[{"builder":5,"attributes":[0],"type":"lookup","passOnNulls":false}],"selectivity":1},"condition":{"expression":"comparison","mode":"=","left":{"expression":"iuref","iu":"v15"},"right":{"expression":"iuref","iu":"v12"}}},"right":{"operator":"tablescan","operatorId":12,"sqlpos":[[302,310]],"cardinality":572,"relationId":7,"schema":{"type":"sessionschema"},"values":[{"name":"l_orderkey","type":["Integer"],"iu":["v17",["Integer"]]},{"name":"l_partkey","type":["Integer"],"iu":null},{"name":"l_suppkey","type":["Integer"],"iu":null},{"name":"l_linenumber","type":["Integer"],"iu":null},{"name":"l_quantity","type":["Numeric",12,2],"iu":["v18",["Numeric",12,2]]},{"name":"l_extendedprice","type":["Numeric",12,2],"iu":null},{"name":"l_discount","type":["Numeric",12,2],"iu":null},{"name":"l_tax","type":["Numeric",12,2],"iu":null},{"name":"l_returnflag","type":["Char1"],"iu":null},{"name":"l_linestatus","type":["Char1"],"iu":null},{"name":"l_shipdate","type":["Date"],"iu":null},{"name":"l_commitdate","type":["Date"],"iu":null},{"name":"l_receiptdate","type":["Date"],"iu":null},{"name":"l_shipinstruct","type":["Char",25],"iu":null},{"name":"l_shipmode","type":["Char",10],"iu":null},{"name":"l_comment","type":["Varchar",44],"iu":null}],"debugName":{"classification":"nonsensitive","value":"lineitem"},"earlyProbes":[{"builder":4,"attributes":[0],"type":"lookup","passOnNulls":false}],"selectivity":1},"condition":{"expression":"comparison","mode":"=","left":{"expression":"iuref","iu":"v11"},"right":{"expression":"iuref","iu":"v17"}}},"keyExpressions":[{"expression":{"value":{"expression":"iuref","iu":"v16"}},"iu":["v",["Varchar",25]]},{"expression":{"value":{"expression":"iuref","iu":"v15"}},"iu":["v2",["Integer"]]},{"expression":{"value":{"expression":"iuref","iu":"v11"}},"iu":["v3",["Integer"]]},{"expression":{"value":{"expression":"iuref","iu":"v14"}},"iu":["v4",["Date"]]},{"expression":{"value":{"expression":"iuref","iu":"v13"}},"iu":["v5",["Numeric",12,2]]}],"groupingSets":[{"keyIndices":[0,1,2,3,4],"coreIndices":[0,1,2,3,4],"behavior":"regular"}],"emptyGroups":false,"aggExpressions":[{"value":{"expression":"iuref","iu":"v18"}}],"aggregates":[{"source":0,"operation":{"aggregate":"sum"},"iu":["v6",["BigNumeric",38,2]]}]}}})HYPERPLAN";

    buffers::view::PlanLayoutConfig config;
    config.mutate_level_height(20.0);
    config.mutate_node_height(8.0);
    config.mutate_padding_left(2.0);
    config.mutate_padding_right(2.0);
    config.mutate_max_label_chars(20);
    config.mutate_width_per_label_char(2.0);
    config.mutate_min_node_width(8);

    PlanViewModel model;
    model.Configure(config);
    auto status = model.ParseHyperPlan(std::string{plan});
    ASSERT_EQ(status, buffers::status::StatusCode::OK) << buffers::status::EnumNameStatusCode(status);
    model.ComputeLayout();
}

TEST(PlanViewModelTest, HyperTPCHQ22) {
    std::string_view plan =
        R"HYPERPLAN({"operator":"executiontarget","operatorId":1,"cardinality":6.26608,"producesRows":true,"output":[{"expression":"iuref","iu":["v",["Varchar"]]},{"expression":"iuref","iu":["v2",["BigInt"]]},{"expression":"iuref","iu":["v3",["BigNumeric",38,2]]}],"outputNames":["cntrycode","numcust","totacctbal"],"input":{"operator":"sort","operatorId":2,"sqlpos":[[1481,1490]],"cardinality":6.26608,"criterion":[{"value":{"expression":"iuref","iu":"v"},"descending":false,"nullFirst":false}],"input":{"operator":"groupby","operatorId":3,"sqlpos":[[1437,1463],[160,168],[189,203]],"cardinality":6.26608,"input":{"operator":"map","operatorId":4,"sqlpos":[[280,324]],"cardinality":6.96232,"input":{"operator":"join","operatorId":5,"cardinality":6.96232,"method":"hash","singleMatch":true,"left":{"operator":"groupby","operatorId":6,"sqlpos":[[691,705]],"cardinality":1,"input":{"operator":"tablescan","operatorId":7,"sqlpos":[[783,791]],"cardinality":37,"relationId":5,"schema":{"type":"sessionschema"},"values":[{"name":"c_custkey","type":["Integer"],"iu":null},{"name":"c_name","type":["Varchar",25],"iu":null},{"name":"c_address","type":["Varchar",40],"iu":null},{"name":"c_nationkey","type":["Integer"],"iu":null},{"name":"c_phone","type":["Char",15],"iu":["v4",["Char",15]]},{"name":"c_acctbal","type":["Numeric",12,2],"iu":["v5",["Numeric",12,2]]},{"name":"c_mktsegment","type":["Char",10],"iu":null},{"name":"c_comment","type":["Varchar",117],"iu":null}],"debugName":{"classification":"nonsensitive","value":"customer"},"filters":[{"attribute":5,"mode":"&gt;","value":{"expression":"const","value":{"type":["Numeric",12,2],"value":0}}},{"attribute":4,"mode":"lambda","expression":{"expression":"lookup","input":[{"expression":"substring","arguments":[{"expression":"iuref","iu":"v4"},{"expression":"const","value":{"type":["Integer"],"value":1}},{"expression":"const","value":{"type":["Integer"],"value":2}}]}],"values":[{"type":["Varchar"],"value":"13"},{"type":["Varchar"],"value":"17"},{"type":["Varchar"],"value":"18"},{"type":["Varchar"],"value":"23"},{"type":["Varchar"],"value":"29"},{"type":["Varchar"],"value":"30"},{"type":["Varchar"],"value":"31"}],"collates":[null],"modes":["equals"]}}],"selectivity":0.286822},"groupingSets":[{"keyIndices":[],"coreIndices":null,"behavior":"static"}],"emptyGroups":true,"aggExpressions":[{"value":{"expression":"iuref","iu":"v5"}}],"aggregates":[{"source":0,"operation":{"aggregate":"avg"},"iu":["v6",["Numeric",16,6,"nullable"]]}]},"right":{"operator":"leftantijoin","operatorId":8,"cardinality":13.9246,"method":"hash","referencedByScanEarlyProbe":true,"left":{"operator":"tablescan","operatorId":9,"sqlpos":[[405,413]],"cardinality":38,"relationId":5,"schema":{"type":"sessionschema"},"values":[{"name":"c_custkey","type":["Integer"],"iu":["v7",["Integer"]]},{"name":"c_name","type":["Varchar",25],"iu":null},{"name":"c_address","type":["Varchar",40],"iu":null},{"name":"c_nationkey","type":["Integer"],"iu":null},{"name":"c_phone","type":["Char",15],"iu":["v8",["Char",15]]},{"name":"c_acctbal","type":["Numeric",12,2],"iu":["v9",["Numeric",12,2]]},{"name":"c_mktsegment","type":["Char",10],"iu":null},{"name":"c_comment","type":["Varchar",117],"iu":null}],"debugName":{"classification":"nonsensitive","value":"customer"},"filters":[{"attribute":4,"mode":"lambda","expression":{"expression":"lookup","input":[{"expression":"substring","arguments":[{"expression":"iuref","iu":"v8"},{"expression":"const","value":{"type":["Integer"],"value":1}},{"expression":"const","value":{"type":["Integer"],"value":2}}]}],"values":[{"type":["Varchar"],"value":"13"},{"type":["Varchar"],"value":"17"},{"type":["Varchar"],"value":"18"},{"type":["Varchar"],"value":"23"},{"type":["Varchar"],"value":"29"},{"type":["Varchar"],"value":"30"},{"type":["Varchar"],"value":"31"}],"collates":[null],"modes":["equals"]}}],"selectivity":0.294574},"right":{"operator":"tablescan","operatorId":10,"sqlpos":[[1282,1288]],"cardinality":128,"relationId":6,"schema":{"type":"sessionschema"},"mightScanDomain":true,"values":[{"name":"o_orderkey","type":["Integer"],"iu":null},{"name":"o_custkey","type":["Integer"],"iu":["v10",["Integer"]]},{"name":"o_orderstatus","type":["Char1"],"iu":null},{"name":"o_totalprice","type":["Numeric",12,2],"iu":null},{"name":"o_orderdate","type":["Date"],"iu":null},{"name":"o_orderpriority","type":["Char",15],"iu":null},{"name":"o_clerk","type":["Char",15],"iu":null},{"name":"o_shippriority","type":["Integer"],"iu":null},{"name":"o_comment","type":["Varchar",79],"iu":null}],"debugName":{"classification":"nonsensitive","value":"orders"},"earlyProbes":[{"builder":8,"attributes":[1],"type":"lookup","passOnNulls":false}],"selectivity":1},"condition":{"expression":"comparison","mode":"=","left":{"expression":"iuref","iu":"v10"},"right":{"expression":"iuref","iu":"v7"}}},"condition":{"expression":"comparison","mode":"&gt;","left":{"expression":"iuref","iu":"v9"},"right":{"expression":"iuref","iu":"v6"}}},"values":[{"iu":["v11",["Varchar"]],"value":{"expression":"substring","arguments":[{"expression":"iuref","iu":"v8"},{"expression":"const","value":{"type":["Integer"],"value":1}},{"expression":"const","value":{"type":["Integer"],"value":2}}]}}]},"keyExpressions":[{"expression":{"value":{"expression":"iuref","iu":"v11"}},"iu":["v",["Varchar"]]}],"groupingSets":[{"keyIndices":[0],"coreIndices":[0],"behavior":"regular"}],"emptyGroups":false,"aggExpressions":[{"value":{"expression":"iuref","iu":"v9"}}],"aggregates":[{"source":0,"operation":{"aggregate":"sum"},"iu":["v3",["BigNumeric",38,2]]},{"source":4294967295,"operation":{"aggregate":"count"},"iu":["v2",["BigInt"]]}]}}})HYPERPLAN";

    buffers::view::PlanLayoutConfig config;
    config.mutate_level_height(20.0);
    config.mutate_node_height(8.0);
    config.mutate_padding_left(2.0);
    config.mutate_padding_right(2.0);
    config.mutate_max_label_chars(20);
    config.mutate_width_per_label_char(2.0);
    config.mutate_min_node_width(8);

    PlanViewModel model;
    model.Configure(config);
    auto status = model.ParseHyperPlan(std::string{plan});
    ASSERT_EQ(status, buffers::status::StatusCode::OK) << buffers::status::EnumNameStatusCode(status);
    model.ComputeLayout();
}

}  // namespace
