name: Main

on:
    push:
        branches-ignore:
            - 'renovate/*'
    pull_request:
        branches:
            - 'main'

jobs:
    build:
        uses: ./.github/workflows/build.yml
        with:
            sha: github.event.inputs.sha
        secrets: inherit

    coverage:
        name: Build Coverage Report
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        runs-on: ubuntu-22.04
        needs:
            - build
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: 'recursive'
                  fetch-depth: 0
                  ref: ${{ github.event.inputs.sha || github.sha }}

            - uses: actions/download-artifact@v4
              with:
                  name: sqlynx_coverage_native_o0
                  path: ./packages/sqlynx-core/build/coverage/

            - uses: actions/download-artifact@v4
              with:
                  name: sqlynx_coverage_js
                  path: ./packages/sqlynx-core-api/coverage/

            - name: Upload coverage report
              uses: coverallsapp/github-action@v2
              with:
                  github-token: ${{secrets.GITHUB_TOKEN}}

    pages:
        name: Deploy GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        runs-on: ubuntu-22.04
        needs:
            - build
        permissions:
            contents: read
            pages: write
            id-token: write
        steps:
            - uses: actions/download-artifact@v4
              with:
                  name: sqlynx_pwa_pages
                  path: ./page

            - uses: actions/upload-pages-artifact@v3
              with:
                  path: ./page

            - uses: actions/deploy-pages@v4
