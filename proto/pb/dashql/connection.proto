syntax = "proto3";

import "dashql/error.proto";
import "dashql/auth.proto";
import "salesforce/hyperdb/grpc/v1/hyper_service.proto";
import "google/protobuf/timestamp.proto";

package dashql;

// ---------------------------------------------------------------------------

/// Setup Timings
message SetupTimings {
    /// Timestamps for channel setup
    optional google.protobuf.Timestamp channel_setup_started_at = 1;
    optional google.protobuf.Timestamp channel_setup_cancelled_at = 2;
    optional google.protobuf.Timestamp channel_setup_failed_at = 3;
    optional google.protobuf.Timestamp channel_ready_at = 4;

    /// Timestamps for health checks
    optional google.protobuf.Timestamp health_check_started_at = 5;
    optional google.protobuf.Timestamp health_check_cancelled_at = 6;
    optional google.protobuf.Timestamp health_check_failed_at = 7;
    optional google.protobuf.Timestamp health_check_succeeded_at = 8;
}

// ---------------------------------------------------------------------------

message ConnectionQueryMetrics {
    /// The total query count
    int64 total_queries = 1;
    /// The total number of received batches
    int64 total_batches_received = 2;
    /// The total number of received rows
    int64 total_rows_received = 3;
    /// The accumulated time until the first batch
    int64 accumulated_time_until_first_batch = 4;
    /// The accumulated query duration
    int64 accumulated_query_duration = 5;
}

message ConnectionMetrics {
    /// The successfull queries
    ConnectionQueryMetrics successful_queries = 1;
    /// The cancelled queries
    ConnectionQueryMetrics canceled_queries = 2;
    /// The failed queries
    ConnectionQueryMetrics failed_queries = 3;
}

// ---------------------------------------------------------------------------

/// Connection Parameters - Demo
message DemoParams {}

/// Connection Details - Demo
message DemoConnectionDetails {
    /// The params
    DemoParams setup_params = 1;
    /// Currently demo connections have minimal serializable state
    /// The channel is created on-demand
    optional DetailedError channel_error = 2;
}

// ---------------------------------------------------------------------------

/// Connection Parameters - Serverless
message ServerlessParams {}

// ---------------------------------------------------------------------------

/// TLS Configuration
message TlsConfig {
    /// The path to the client private key
    string client_key_path = 1;
    /// The path to the client public key
    string client_cert_path = 2;
    /// The path to the CA certificates
    string ca_certs_path = 3;
}

/// Connection Parameters - Hyper
message HyperConnectionParams {
    /// The endpoint
    string endpoint = 1;
    /// The TLS config
    TlsConfig tls = 2;
    /// The attached databases
    repeated salesforce.hyperdb.grpc.v1.AttachedDatabase attached_databases = 3;
    /// The metadata
    map<string, string> metadata = 4;
}

/// Connection Details - Hyper
message HyperConnectionDetails {
    /// The setup timings
    SetupTimings setup_timings = 1;
    /// The channel setup parameters
    HyperConnectionParams setup_params = 2;
    /// The channel setup error (if any)
    optional DetailedError channel_error = 3;
    /// The health check error (if any)
    optional DetailedError health_check_error = 4;
}

// ---------------------------------------------------------------------------

/// Setup Timings - Salesforce
message SalesforceSetupTimings {
    /// All the base timing fields
    optional google.protobuf.Timestamp channel_setup_started_at = 1;
    optional google.protobuf.Timestamp channel_setup_cancelled_at = 2;
    optional google.protobuf.Timestamp channel_setup_failed_at = 3;
    optional google.protobuf.Timestamp channel_ready_at = 4;
    optional google.protobuf.Timestamp health_check_started_at = 5;
    optional google.protobuf.Timestamp health_check_cancelled_at = 6;
    optional google.protobuf.Timestamp health_check_failed_at = 7;
    optional google.protobuf.Timestamp health_check_succeeded_at = 8;

    /// Salesforce-specific auth timings
    optional google.protobuf.Timestamp auth_started_at = 10;
    optional google.protobuf.Timestamp auth_cancelled_at = 11;
    optional google.protobuf.Timestamp auth_failed_at = 12;
    optional google.protobuf.Timestamp pkce_gen_started_at = 13;
    optional google.protobuf.Timestamp pkce_gen_finished_at = 14;
    optional google.protobuf.Timestamp opened_native_auth_link_at = 15;
    optional google.protobuf.Timestamp opened_web_auth_window_at = 16;
    optional google.protobuf.Timestamp closed_web_auth_window_at = 17;
    optional google.protobuf.Timestamp oauth_code_received_at = 18;
    optional google.protobuf.Timestamp core_access_token_requested_at = 19;
    optional google.protobuf.Timestamp core_access_token_received_at = 20;
    optional google.protobuf.Timestamp data_cloud_access_token_requested_at = 21;
    optional google.protobuf.Timestamp data_cloud_access_token_received_at = 22;
    optional google.protobuf.Timestamp data_cloud_metadata_requested_at = 23;
    optional google.protobuf.Timestamp data_cloud_metadata_received_at = 24;
}

/// Connection Parameters - Salesforce
message SalesforceConnectionParams {
    /// The instance url
    string instanceUrl = 1;
    /// The key of the connected app
    string appConsumerKey = 2;
    /// The secret of the connected app
    string appConsumerSecret = 3;
    /// The login
    string login = 4;
}

/// Connection Details - Salesforce
message SalesforceConnectionDetails {
    /// The setup timings (if any)
    SalesforceSetupTimings setup_timings = 1;
    /// The setup parameters (if any)
    SalesforceConnectionParams setup_params = 2;
    /// The auth state (if any)
    optional SalesforceOAuthState oauth_state = 3;
    /// The setup error (if any)
    optional DetailedError setup_error = 4;
    /// The channel error (if any)
    optional DetailedError channel_error = 5;
    /// The health check error (if any)
    optional DetailedError health_check_error = 6;

    // Note: Runtime-only fields like PKCEChallenge, Window objects,
    // tokens, and channel instances cannot be serialized and will remain 
    // TypeScript-only in an extended interface
}

message SalesforceOAuthConfig {
    /// The oauth redirect
    string oauth_redirect = 1;
}

/// The oauth state
message SalesforceOAuthState {
    //// The oauth parameters
    SalesforceOAuthParams oauth_params = 1;
    /// The oauth PKCE challenge
    OAuthPKCEChallenge oauth_pkce = 2;
    /// The core auth code that we can trade for an access token
    TemporaryToken core_auth_code = 3;
    /// The core access token
    SalesforceCoreAccessToken core_access_token = 4;
    /// The data cloud access token
    SalesforceDataCloudAccessToken data_cloud_access_token = 5;
}


message SalesforceCoreAccessToken {
    /// Created token at timestamp
    google.protobuf.Timestamp created_at = 11;
    /// The OAuth token
    string access_token = 1;
    /// A URL indicating the instance of the userâ€™s org
    optional string instance_url = 2;
    /// The instance url
    optional string api_instance_url = 3;
    /// An identity URL that can be used to identify the user and to query
    optional string id = 4;
    /// A signed data structure that contains authenticated user attributes
    optional string id_token = 5;
    /// Time stamp of when the signature was created
    optional google.protobuf.Timestamp issued_at = 6;
    /// Token obtained from the web server, user-agent, or hybrid app token flow
    optional string refresh_token = 7;
    /// The scopes associated with the access token.
    optional string scope = 8;
    /// Base64-encoded HMAC-SHA256 signature
    optional string signature = 9;
    /// A Bearer token type
    optional string token_type = 10;
}

message SalesforceCoreUserInfoPhotos {
    /// User picture
    optional string picture = 1;
    /// User thumbnail
    optional string thumbnail = 2;
}

message SalesforceCoreUserInfo {
    /// Active user?
    optional bool active = 1;
    /// User email
    optional string email = 2;
    /// User email verified?
    optional bool email_verified = 3;
    /// Family name
    optional string family_name = 4;
    /// Given name
    optional string given_name = 5;
    /// Is app installed?
    optional bool is_app_installed = 6;
    /// Is Salesforce integration user?
    optional bool is_salesforce_integration_user = 7;
    /// Language
    optional string language = 8;
    /// Locale
    optional string locale = 9;
    /// Name
    optional string name = 10;
    /// Nickname
    optional string nickname = 11;
    /// Organization ID
    optional string organization_id = 12;
    /// Picture URL
    optional string picture = 13;
    /// Preferred username
    optional string preferred_username = 14;
    /// Profile URL
    optional string profile = 15;
    /// Subject
    optional string sub = 16;
    /// Updated at timestamp
    optional string updated_at = 17;
    /// User ID
    optional string user_id = 18;
    /// User type
    optional string user_type = 19;
    /// UTC offset in milliseconds
    optional int32 utc_offset = 20;
    /// Timezone info
    optional string zoneinfo = 21;
    /// Photo URLs (picture and thumbnail)
    SalesforceCoreUserInfoPhotos photos = 22;
}

message SalesforceDataCloudJWTPayload {
    /// The JWT subject
    string sub = 1;
    /// The JWT audience
    string aud = 2;
    /// The JWT expiration time, seconds since epoch for SF
    string exp = 3;
    /// The time when the JWT was issued
    string iat = 4;
    //// The unique id of the JWT token
    string jti = 5;
    /// The JWT scope
    string scp = 6;
    /// The JWT issuer
    string iss = 7;
    /// The time when the JWT becomes valid
    string nbf = 8;

    /// The SF core org id
    string org_id = 9;
    /// The SF app id
    string sfappid = 10;
    /// The SF oid
    string sfoid = 11;
    /// The SF uid
    string sfuid = 12;

    /// The SF core tenant id of the issuer
    string issuer_tenant_id = 13;
    /// The SF offcore tenant id required for the DC api
    string audience_tenant_id = 14;
    /// The custom attributes (contains "dataspace")
    map<string, string> custom_attributes = 15;
}

message SalesforceDataCloudJWT {
    /// The raw JWT
    string raw = 1;
    /// The JWT header
    map<string, string> header = 2;
    /// The JWT payload
    SalesforceDataCloudJWTPayload payload = 3;
}

message SalesforceDataCloudAccessToken {
    /// Created token at timestamp
    google.protobuf.Timestamp created_at = 11;
    /// The jwt
    SalesforceDataCloudJWT jwt = 1;
    /// The time when the token expires
    google.protobuf.Timestamp expires_at = 2;
    /// The token type
    optional string token_type = 3;
    /// The issued token type
    optional string issued_token_type = 4;
    /// The instance URL
    optional string instance_url = 5;
}

/// Salesforce Metadata Entity Field
message SalesforceDataCloudMetadataEntityField {
    /// The field name
    string name = 1;
    /// The field display name
    string display_name = 2;
    /// The field type
    string type = 3;
    /// The business type
    string business_type = 4;
}

/// Salesforce Metadata Primary Key
message SalesforceDataCloudMetadataPrimaryKey {
    /// The index order
    string index_order = 1;
    /// The primary key name
    string name = 2;
    /// The primary key display name
    string display_name = 3;
}

/// Salesforce Metadata Entity
message SalesforceDataCloudMetadataEntity {
    /// The entity name
    string name = 1;
    /// The entity display name
    string display_name = 2;
    /// The entity category
    string category = 3;
    /// The entity fields
    repeated SalesforceDataCloudMetadataEntityField fields = 4;
    /// The entity primary keys
    repeated SalesforceDataCloudMetadataPrimaryKey primary_keys = 5;
}

/// Salesforce Metadata
message SalesforceDataCloudMetadata {
    /// The metadata entities
    repeated SalesforceDataCloudMetadataEntity metadata = 1;
}

// ---------------------------------------------------------------------------

/// Trino auth parameters
message TrinoAuthParams {
    /// The username
    string username = 1;
    /// The secret
    string secret = 2;
}

/// Connection Parameters - Details
message TrinoConnectionParams {
    /// The endpoint
    string endpoint = 1;
    /// The authentication params
    TrinoAuthParams auth = 2;
    /// The catalog name
    string catalog_name = 3;
    /// The schema name
    repeated string schema_names = 4;
    /// The metadata
    map<string, string> metadata = 5;
}

/// Connection Details - Trino
message TrinoConnectionDetails {
    /// The setup timings
    SetupTimings setup_timings = 1;
    /// The channel parameters
    TrinoConnectionParams setup_params = 2;
    /// The channel error (if any)
    optional DetailedError channel_error = 3;
    /// The health check error (if any)
    optional DetailedError health_check_error = 4;
    /// The schema resolution error (if any)
    optional DetailedError schema_resolution_error = 5;
}

// ---------------------------------------------------------------------------

/// Connection Parameters - Variant
message ConnectionParams {
    oneof connection {
        /// Parameters for Serverless sessions
        ServerlessParams serverless = 1;
        /// Parameters for direct-to-Hyper connections
        HyperConnectionParams hyper = 20;
        /// Parameters for Salesforce connections
        SalesforceConnectionParams salesforce = 30;
        /// Parameters for trino connections
        TrinoConnectionParams trino = 50;
        /// Parameters for demo sessions
        DemoParams demo = 100;
    }
}

/// Connection State Details
message ConnectionStateDetails {
    oneof details {
        /// Empty for serverless (no state to persist)
        ServerlessParams serverless = 1;
        /// Details for Hyper gRPC connections
        HyperConnectionDetails hyper = 2;
        /// Details for Salesforce connections
        SalesforceConnectionDetails salesforce = 3;
        /// Details for Trino connections
        TrinoConnectionDetails trino = 4;
        /// Details for Demo connections
        DemoConnectionDetails demo = 5;
    }
}
